# Plan: Artwork Persistence (Base64 in Metadata)

This plan outlines the steps to implement persistence for project cover artwork by storing base64 encoded image data within the existing `metadata` table in the project's `.mns` (SQLite) file.

## 1. [COMPLETE] Update Types

*   **Goal:** Add fields to store the base64 encoded image data and its mime type. The existing `cover` field will be used for the displayable data URL.
*   **File:** `src/renderer/src/types.ts`
*   **Action:**
    *   In `ProjectFragment`: Added `coverImageMimeType?: string | null`.
    *   In `Project`: Added `coverImageBase64?: string | null`. (`coverImageMimeType` is inherited). Updated `coverImageMimeType` to allow `null`.
*   **Status:** COMPLETE

## 2. [COMPLETE] Add Artwork Input UI & State Update

*   **Goal:** Allow the user to select an image file (via click or drag-and-drop) and update the active project state with the base64 data and mime type, including file restrictions.
*   **Files:** `src/renderer/src/pages/ProjectParameters.tsx`, `src/renderer/src/lib/store/projectsSlice.ts`.
*   **Action:**
    *   In `projectsSlice.ts`: Added `updateCoverImage` reducer to update `coverImageBase64`, `coverImageMimeType`, clear `cover`, and set `projectHasLiveEdits`. Exported the action.
    *   In `ProjectParameters.tsx`: Added UI elements (image preview, hidden file input, "Change Cover" button, drop zone), state for preview URL and drag state, `useEffect` hook to update local state (fixed infinite loop issue), drag-and-drop handlers (`handleDragEnter`, `handleDragLeave`, `handleDragOver`, `handleDrop`), `handleCoverButtonClick` to trigger input, and `processImageFile` function (used by drop and file change handlers) to read the file, **validate type (JPEG, PNG, WebP) and size (max 5MB)**, extract base64/mime, update preview state, and dispatch `updateCoverImage`. Removed unused imports. Updated layout to center image and place button below.
*   **Status:** COMPLETE

## 3. [COMPLETE] Update Save Logic (Backend)

*   **Goal:** Save the base64 data and mime type into the `metadata` table.
*   **File:** `src/main/sqliteOps.ts`
*   **Action:** In `handleSaveSqliteProject`:
    *   Included `coverImageBase64: project.coverImageBase64` and `coverImageMimeType: project.coverImageMimeType` in the `metadataToSave` object.
    *   Added `DELETE FROM metadata` before inserting to handle removed keys.
    *   Modified insert loop to store `coverImageBase64` directly as TEXT and others as JSON strings, handling `undefined` values.
*   **Status:** COMPLETE

## 4. [COMPLETE] Update Load Logic (Backend)

*   **Goal:** Retrieve the base64 data and mime type when loading.
*   **File:** `src/main/sqliteOps.ts`
*   **Action:**
    *   In `handleLoadSqliteProject`: Ensured the metadata reduce logic correctly retrieves `coverImageBase64` (as string) and `coverImageMimeType`.
    *   In `handleGetSqliteProjectMeta`: Updated the reduce logic to correctly retrieve `coverImageBase64` (as string) and `coverImageMimeType` (as string) and include them in the returned metadata object.
*   **Status:** COMPLETE

## 5. [COMPLETE] Create Data URL for Display

*   **Goal:** Generate the `cover` data URL from the loaded base64 data and mime type for easy use in UI components.
*   **File:** `src/renderer/src/lib/store/projectsSlice.ts`.
*   **Action:** Added `selectActiveProjectWithCoverDataUrl` selector. It gets the `activeProject`, checks for `coverImageBase64` and `coverImageMimeType`, constructs the data URL (`data:${mimeType};base64,${base64Data}`), and assigns it to the `cover` field of a *copy* of the project object before returning. Components needing the cover image should use this selector.
*   **Status:** COMPLETE

## 6. [COMPLETE] Update Display Logic

*   **Goal:** Ensure the `ProjectCard` displays the cover image correctly using the data URL.
*   **File:** `src/renderer/src/components/ProjectLibrary.tsx`
*   **Action:** Modified `ProjectCard` to use the `project.cover` property (which should contain the data URL generated by the selector or constructed in `getProjectFragmentMeta`) directly in the `backgroundImage` style, falling back to the genre image if `project.cover` is falsy.
*   **Status:** COMPLETE

## 7. [COMPLETE] Create Plan Documentation

*   **Goal:** Save this plan for reference.
*   **File:** `memory-bank/artwork-persistence-plan.md`
*   **Action:** Use `write_to_file` to save the plan details.
*   **Status:** COMPLETE

## 8. [COMPLETE] Add File Restrictions

*   **Goal:** Implement client-side validation for uploaded cover images.
*   **File:** `src/renderer/src/pages/ProjectParameters.tsx`
*   **Action:** Added checks within `processImageFile` to validate file type against `ALLOWED_IMAGE_TYPES` (JPEG, PNG, WebP) and file size against `MAX_IMAGE_SIZE_BYTES` (5MB). Updated UI text and input `accept` attribute.
*   **Status:** COMPLETE
